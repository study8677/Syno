{% extends "base.html" %}
{% block title %}AI 设置 · Syno{% endblock %}
{% block content %}
<div class="max-w-3xl space-y-6">
  <div>
    <h1 class="text-2xl font-semibold">AI 设置</h1>
    <p class="text-gray-600">配置 OpenAI 或兼容接口的访问参数。密钥仅保存在本浏览器会话中，不会回显。</p>
  </div>

  {% if saved %}
    <div class="rounded-md border border-green-200 bg-green-50 text-green-800 p-3">已保存</div>
  {% endif %}

  <form class="grid grid-cols-1 md:grid-cols-2 gap-4" method="post" action="/ai">
    <div>
      <label class="block text-sm text-gray-600 mb-1">提供方</label>
      <select name="provider" class="w-full rounded-lg border-gray-300 focus:border-brand focus:ring-brand">
        <option value="fake" {{ 'selected' if (cfg.get('provider') == 'fake') else '' }}>Fake（离线）</option>
        <option value="openai" {{ 'selected' if (cfg.get('provider') == 'openai') else '' }}>OpenAI</option>
        <option value="compat" {{ 'selected' if (cfg.get('provider') == 'compat') else '' }}>OpenAI 兼容</option>
      </select>
    </div>
    <div>
      <label class="block text-sm text-gray-600 mb-1">模型 ID</label>
      <input name="model" value="{{ cfg.get('model','gpt-4o-mini') }}" class="w-full rounded-lg border-gray-300 focus:border-brand focus:ring-brand" placeholder="例如：gpt-4o-mini 或 openrouter/..." />
    </div>
    <div>
      <label class="block text-sm text-gray-600 mb-1">兼容预设（可选）</label>
      <select name="compat_name" class="w-full rounded-lg border-gray-300 focus:border-brand focus:ring-brand">
        {% set cname = cfg.get('compat_name') %}
        <option value="">-- 自定义/不使用 --</option>
        {% for n in ['openrouter','groq','deepseek','dashscope','qwen','xai','ollama','zhipu','moonshot','siliconflow','doubao'] %}
          <option value="{{n}}" {{ 'selected' if cname==n else '' }}>{{ n }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-sm text-gray-600 mb-1">Base URL（可选）</label>
      <input name="base_url" value="{{ cfg.get('base_url','') }}" class="w-full rounded-lg border-gray-300 focus:border-brand focus:ring-brand" placeholder="自动从预设填充，或自定义" />
    </div>
    <div>
      <label class="block text-sm text-gray-600 mb-1">API Key（不会回显）</label>
      <input name="api_key" type="password" value="" class="w-full rounded-lg border-gray-300 focus:border-brand focus:ring-brand" placeholder="{{ '已设置' if has_key else 'sk-...' }}" />
    </div>
    <div>
      <label class="block text-sm text-gray-600 mb-1">温度（0-1）</label>
      <input name="temperature" type="number" step="0.1" min="0" max="1" value="{{ cfg.get('temperature',0.4) }}" class="w-full rounded-lg border-gray-300 focus:border-brand focus:ring-brand" />
    </div>

    <div class="md:col-span-2 flex items-center gap-3">
      <button class="inline-flex items-center px-4 py-2 rounded-md bg-brand text-white hover:opacity-90" type="submit">保存</button>
      <form method="post" action="/ai/test">
        <button class="inline-flex items-center px-4 py-2 rounded-md border border-gray-300 bg-white hover:bg-gray-50" type="submit">测试调用</button>
      </form>
      <a class="text-gray-600 hover:text-gray-900" href="/ask">去提问</a>
    </div>
  </form>

  {% if test_result is not none %}
    <div class="rounded-lg border {{ 'border-green-200 bg-green-50 text-green-800' if test_ok else 'border-red-200 bg-red-50 text-red-800' }} p-4 whitespace-pre-wrap">
      {{ test_result }}
    </div>
  {% endif %}
</div>
{% endblock %}
