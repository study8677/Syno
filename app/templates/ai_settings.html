{% extends "base.html" %}
{% block title %}AI 设置 · Syno{% endblock %}
{% block content %}
<section class="col-span-12 md:col-span-8 space-y-6">
  <div class="rounded-2xl border border-gray-200 bg-white p-6">
    <div class="mb-4">
      <h1 class="text-2xl font-semibold">AI 设置</h1>
      <p class="text-gray-600">配置 OpenAI 或兼容接口的访问参数。密钥仅保存在本浏览器会话中，不会回显。</p>
    </div>

    {% if saved %}
      <div class="mb-4 rounded-md border border-green-200 bg-green-50 text-green-800 p-3">已保存</div>
    {% endif %}

    <form id="cfg" class="grid grid-cols-1 md:grid-cols-2 gap-5" method="post" action="/ai">
      <div>
        <label class="block text-sm text-gray-600 mb-1">提供方</label>
        <select name="provider" class="w-full rounded-lg border-gray-300 focus:border-brand focus:ring-brand">
          <option value="fake" {{ 'selected' if (cfg.get('provider') == 'fake') else '' }}>Fake（离线）</option>
          <option value="openai" {{ 'selected' if (cfg.get('provider') == 'openai') else '' }}>OpenAI</option>
          <option value="compat" {{ 'selected' if (cfg.get('provider') == 'compat') else '' }}>OpenAI 兼容</option>
        </select>
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">模型 ID</label>
        <input name="model" value="{{ cfg.get('model','gpt-4o-mini') }}" class="w-full rounded-lg border-gray-300 focus:border-brand focus:ring-brand" placeholder="例如：gpt-4o-mini 或 openrouter/..." />
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">兼容预设（可选）</label>
        <select name="compat_name" class="w-full rounded-lg border-gray-300 focus:border-brand focus:ring-brand">
          {% set cname = cfg.get('compat_name') %}
          <option value="">-- 自定义/不使用 --</option>
          {% for n in ['openrouter','groq','deepseek','dashscope','qwen','xai','ollama','zhipu','moonshot','siliconflow','doubao'] %}
            <option value="{{n}}" {{ 'selected' if cname==n else '' }}>{{ n }}</option>
          {% endfor %}
        </select>
        <p class="mt-1 text-xs text-gray-500">选择后 base_url 可自动使用预设，也可手动覆盖。</p>
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">Base URL（可选）</label>
        <input name="base_url" value="{{ cfg.get('base_url','') }}" class="w-full rounded-lg border-gray-300 focus:border-brand focus:ring-brand" placeholder="自动从预设填充，或自定义" />
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm text-gray-600 mb-1">API Key（不会回显）</label>
        <input name="api_key" type="password" value="" class="w-full rounded-lg border-gray-300 focus:border-brand focus:ring-brand" placeholder="{{ '已设置' if has_key else 'sk-...' }}" />
      </div>
      <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-5">
        <div>
          <label class="block text-sm text-gray-600 mb-1">温度（0-1）</label>
          <input name="temperature" type="number" step="0.1" min="0" max="1" value="{{ cfg.get('temperature',0.4) }}" class="w-full rounded-lg border-gray-300 focus:border-brand focus:ring-brand" />
        </div>
      </div>

      <div class="md:col-span-2">
        <div class="text-sm font-medium text-gray-800 mb-2">上下文增强</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div>
            <label class="block text-sm text-gray-600 mb-1">答案上下文</label>
            <select name="answer_ctx" class="w-full rounded-lg border-gray-300 focus:border-brand focus:ring-brand">
              {% set ac = cfg.get('answer_ctx','both') %}
              {% for v in ['none','topk'] %}
                <option value="{{v}}" {{ 'selected' if ac==v else '' }}>{{ {'none':'不添加','consensus':'仅共识','topk':'仅Top-K','both':'共识+Top-K'}[v] }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">评论上下文</label>
            <select name="comment_ctx" class="w-full rounded-lg border-gray-300 focus:border-brand focus:ring-brand">
              {% set cc = cfg.get('comment_ctx','topk') %}
              {% for v in ['none','topk'] %}
                <option value="{{v}}" {{ 'selected' if cc==v else '' }}>{{ {'none':'不添加','consensus':'仅共识','topk':'仅Top-K','both':'共识+Top-K'}[v] }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Top-K 答案数</label>
            <input name="ctx_topk" type="number" min="1" max="5" value="{{ cfg.get('ctx_topk',2) }}" class="w-full rounded-lg border-gray-300 focus:border-brand focus:ring-brand" />
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">提要长度上限</label>
            <input name="ctx_snippet" type="number" min="80" max="400" step="20" value="{{ cfg.get('ctx_snippet',200) }}" class="w-full rounded-lg border-gray-300 focus:border-brand focus:ring-brand" />
          </div>
        </div>
      </div>
      <div class="md:col-span-2 flex flex-wrap items-center gap-3">
        <button class="inline-flex items-center px-4 py-2 rounded-md bg-brand text-white hover:bg-brand2" type="submit">保存</button>
        <button form="test" class="inline-flex items-center px-4 py-2 rounded-md border border-gray-300 bg-white hover:bg-gray-50" type="submit">测试调用</button>
        <a class="text-gray-600 hover:text-gray-900" href="/ask">去提问</a>
      </div>
    </form>

    <form id="test" method="post" action="/ai/test"></form>
  </div>

  {% if test_result is not none %}
    <div class="rounded-2xl border {{ 'border-green-200 bg-green-50 text-green-800' if test_ok else 'border-red-200 bg-red-50 text-red-800' }} p-4 whitespace-pre-wrap">
      {{ test_result }}
    </div>
  {% endif %}
</section>

<aside class="col-span-12 md:col-span-4 space-y-4">
  <div class="rounded-2xl border border-gray-200 bg-white p-5">
    <div class="text-sm text-gray-500">常用参考</div>
    <ul class="mt-2 text-sm text-gray-700 space-y-1">
      <li>OpenRouter: https://openrouter.ai/api/v1</li>
      <li>Groq: https://api.groq.com/openai/v1</li>
      <li>DeepSeek: https://api.deepseek.com</li>
      <li>Qwen: https://dashscope.aliyuncs.com/compatible-mode/v1</li>
      <li>xAI: https://api.x.ai/v1</li>
      <li>Ollama: http://localhost:11434/v1</li>
    </ul>
  </div>
</aside>
{% endblock %}
